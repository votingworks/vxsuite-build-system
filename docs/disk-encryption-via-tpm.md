For automated TPM disk encryption, there are three specific operations during the build, lockdown, and initial boot of a machine. Here's the overview of each:

During Trusted Build, the /var partition is encrypted very early on with the insecure passphrase. It is configured via a passphrase stored in a keyfile so a user does not have to enter it manually during boot, but in the event of any issue, you can fall back to manual entry of the passphrase. This encryption is done as early as possible to eliminate the need to change our partition sizes or deal with potential space issues during the build process. Any images we build for internal testing will use this level of encryption at a minimum. It is currently not applied to Parallels or other localdev environments.

During [lockdown.sh](https://github.com/votingworks/vxsuite-complete-system/blob/main/config/admin-functions/lockdown.sh), we have to configure /etc/crypttab with an entry for the /var partition to use the TPM. This entry does not work unless the system eventually encrypts via the TPM. The reason for this invalid entry is that we make the root partition read-only before dm-verity, and that means we can't change /etc/crypttab when flashing individual machines. This is actually fine though, because the system will fall back to prompting for the passphrase, allowing the system to continue booting.

During the initial boot after flashing, we have to create a new, randomized key, re-encrypt /var with it, store the key in the TPM, and delete all other passphrases and key files. This can be seen in [rekey_via_tpm.sh](https://github.com/votingworks/vxsuite-complete-system/blob/main/config/admin-functions/rekey_via_tpm.sh). We are only allowing TPM encryption to happen if multiple conditions are met. If this part goes wrong, you can effectively brick the installed image and you'll have to start over. This also allows us to use the initial encryption via the insecure passphrase/keyfile on our QA / unsigned images.
