---

- name: Generate a report of COTS tools used for this build
  hosts: 127.0.0.1
  connection: local
  become: true

  tasks:
    - name: De-dupe the list for efficiency
      set_fact:
        all_packages: "{{ all_packages | unique | select | list }}"

    - name: De-dupe the TPM list for efficiency
      set_fact:
        tpm_packages: "{{ tpm_packages | unique | select | list }}"

    - name: Get the filename in the apt repo
      ansible.builtin.shell:
        cmd: >
          apt-cache show {{ item }} | grep "Filename" | 
          cut -d' ' -f2
      loop: 
        - "{{ all_packages }}"
        - "{{ tpm_packages }}"
      register: apt_filenames

    - name: Print to tmp file
      ansible.builtin.shell:
        cmd: 'echo "  - {{ item.stdout | quote }}" >> /tmp/apt_filenames'
      loop: "{{ apt_filenames.results }}"

